<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.cosmo.mapper.HiwariKinmuchiMapper">

    <!-- 申請前：SHAIN + SHOZOKU -->
<select id="getBeforeShinsei" resultType="org.cosmo.domain.HiwariKinmuchiVO">
    SELECT
        SH.KIGYO_CD,
        SH.SHAIN_UID,

        SH.SHOZOKU_CD      AS beforeShozokuCd,
        SZ.SHOZOKU_NM      AS beforeShozokuNm,

        SH.KINMU_ZIP_CD    AS kinmuZipCd,
        SH.KINMU_PREF_CD   AS kinmuPrefCd,
        C.CODE_NM          AS kinmuPrefNm,       -- ★ 도도부현 이름 추가!
        SH.KINMU_ADDRESS_1 AS kinmuAddress1,
        SH.KINMU_ADDRESS_2 AS kinmuAddress2

    FROM SHAIN SH
    LEFT JOIN SHOZOKU SZ
      ON SH.KIGYO_CD   = SZ.KIGYO_CD
     AND SH.SHOZOKU_CD = SZ.SHOZOKU_CD

    -- ★ 도도부현 코드마스터 JOIN
    LEFT JOIN CODE C
      ON SH.KINMU_PREF_CD = C.CODE
     AND C.CODE_SYBTSU = '003'   -- 003 = 도도부현 코드 그룹

    WHERE SH.KIGYO_CD = #{kigyoCd}
      AND SH.SHAIN_UID = #{shainUid}
</select>

    <!-- 申請後：SHINSEI + SHOZOKU -->
<select id="getAfterShinsei" resultType="org.cosmo.domain.HiwariKinmuchiVO">
    SELECT
        S.KIGYO_CD,
        S.SHAIN_UID,

        S.NEW_SHOZOKU_CD      AS beforeShozokuCd,
        SZ.SHOZOKU_NM         AS beforeShozokuNm,

        S.NEW_KINMU_ZIP_CD    AS kinmuZipCd,
        S.NEW_KINMU_PREF_CD   AS kinmuPrefCd,
        C.CODE_NM             AS kinmuPrefNm,      -- ★ 추가
        S.NEW_KINMU_ADDRESS_1 AS kinmuAddress1,
        S.NEW_KINMU_ADDRESS_2 AS kinmuAddress2

    FROM SHINSEI S
    LEFT JOIN SHOZOKU SZ
      ON S.KIGYO_CD        = SZ.KIGYO_CD
     AND S.NEW_SHOZOKU_CD  = SZ.SHOZOKU_CD

    -- ★ 도도부현 코드 JOIN
    LEFT JOIN CODE C
      ON S.NEW_KINMU_PREF_CD = C.CODE
     AND C.CODE_SYBTSU = '003'

    WHERE S.KIGYO_CD = #{kigyoCd}
      AND S.SHAIN_UID = #{shainUid}
      AND S.SHINSEI_NO = #{shinseiNo}
</select>


    <!-- 所属 리스트 -->
    <select id="getShozokuNames" resultType="string">
        SELECT SHOZOKU_NM
        FROM SHOZOKU
        WHERE KIGYO_CD = #{kigyoCd}
        ORDER BY SHOZOKU_NM
    </select>

</mapper>