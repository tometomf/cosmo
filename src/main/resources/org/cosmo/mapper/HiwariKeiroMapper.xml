<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.cosmo.mapper.HiwariKeiroMapper">

    <!-- 経路VO 매핑 -->
    <resultMap id="HiwariKeiroMap" type="org.cosmo.domain.HiwariKeiroVO">
        <result column="KIGYO_CD"          property="kigyoCd"/>
        <result column="SHINSEI_NO"        property="shinseiNo"/>
        <result column="KEIRO_SEQ"         property="keiroSeq"/>
        <result column="SHAIN_UID"         property="shainUid"/>
        <result column="TSUKIN_SHUDAN_KBN" property="tsukinShudanKbn"/>
        <result column="START_PLACE"       property="startPlace"/>
        <result column="END_PLACE"         property="endPlace"/>
        <result column="KEKKA_SELECT"      property="kekkaSelect"/>
    </resultMap>

    <!-- 로그인사원(가짜 9001)의 최신 신청번호 기준 경로 조회 -->
    <select id="findByUser"
            parameterType="int"
            resultMap="HiwariKeiroMap">
        SELECT
            KIGYO_CD,
            SHINSEI_NO,
            KEIRO_SEQ,
            SHAIN_UID,
            TSUKIN_SHUDAN_KBN,
            START_PLACE,
            END_PLACE,
            KEKKA_SELECT
        FROM
            SHINSEI_START_KEIRO
        WHERE
            KIGYO_CD = 100
          AND SHINSEI_NO = (
                SELECT MAX(SHINSEI_NO)
                  FROM SHINSEI
                 WHERE KIGYO_CD = 100
                   AND SHAIN_UID = #{shainUid}
          )
        ORDER BY
            KEIRO_SEQ
    </select>

    <!-- 해당 사원의 최신 신청에 대한 경로 전체 삭제 -->
    <delete id="deleteByUser" parameterType="int">
        DELETE FROM SHINSEI_START_KEIRO
        WHERE KIGYO_CD = 100
          AND SHINSEI_NO = (
                SELECT MAX(SHINSEI_NO)
                  FROM SHINSEI
                 WHERE KIGYO_CD = 100
                   AND SHAIN_UID = #{shainUid}
          )
    </delete>

    <!-- 경로 1건 저장 -->
    <insert id="insertKeiro"
            parameterType="org.cosmo.domain.HiwariKeiroVO">
        INSERT INTO SHINSEI_START_KEIRO (
            KIGYO_CD,
            SHINSEI_NO,
            KEIRO_SEQ,
            SHAIN_UID,
            TSUKIN_SHUDAN_KBN,
            START_PLACE,
            END_PLACE,
            KEKKA_SELECT
        )
        VALUES (
            100,
            (SELECT MAX(SHINSEI_NO)
               FROM SHINSEI
              WHERE KIGYO_CD = 100
                AND SHAIN_UID = #{shainUid}),
            #{keiroSeq},
            #{shainUid},
            #{tsukinShudanKbn},
            #{startPlace},
            #{endPlace},
            #{kekkaSelect}
        )
    </insert>

    <!-- 경로 1건 삭제 (삭제 링크용)
         - 같은 사원의 "최신 신청번호" + KEIRO_SEQ 로 삭제 -->
    <delete id="deleteOne">
        DELETE FROM SHINSEI_START_KEIRO
        WHERE KIGYO_CD = 100
          AND SHINSEI_NO = (
                SELECT MAX(SHINSEI_NO)
                  FROM SHINSEI
                 WHERE KIGYO_CD = 100
                   AND SHAIN_UID = #{shainUid}
          )
          AND SHAIN_UID = #{shainUid}
          AND KEIRO_SEQ = #{keiroSeq}
    </delete>

</mapper>
