<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.cosmo.mapper.IchijiHozonMapper">

	<!-- 1) USER_UID으로 UPDATE -->
	<update id="updateByUserAndAction"
		parameterType="org.cosmo.domain.IchijiHozonDTO">

		UPDATE ICHIJI_HOZON
		SET
		SHINSEI_KBN = #{shinseiKbn},
		SHOZOKU_CD = #{shozokuCd},
		DATA = #{data, jdbcType=BLOB},
		UPD_USER_ID =
		#{updUserId},
		UPD_DATE = SYSTIMESTAMP
		WHERE USER_UID = #{userUid}
	</update>

	<!-- 2) INSERT (새 임시저장 레코드) -->
	<insert id="insertIchijiHozon"
		parameterType="org.cosmo.domain.IchijiHozonDTO">

		<!-- HOZON_UID 시퀀스 사용 -->
		<selectKey keyProperty="hozonUid" resultType="int"
			order="BEFORE">
			SELECT ICHIJI_HOZON_SEQ.NEXTVAL FROM DUAL
		</selectKey>

		INSERT INTO ICHIJI_HOZON (
		HOZON_UID,
		USER_UID,
		SHINSEI_KBN,
		SHOZOKU_CD,
		ALERT_NO,
		ALERT_SEQ,
		ACTION_NM,
		DATA,
		ADD_USER_ID,
		ADD_DATE,
		UPD_USER_ID,
		UPD_DATE
		) VALUES (
		#{hozonUid},
		#{userUid},
		#{shinseiKbn},
		#{shozokuCd},
		NULL,
		NULL,
		#{actionNm},
		#{data, jdbcType=BLOB},
		#{addUserId},
		SYSTIMESTAMP,
		#{updUserId},
		SYSTIMESTAMP
		)
	</insert>

	<!-- 3) 최신 1건 조회 (USER_UID + ACTION_NM 기준) -->
	<select id="selectLatestByUserAndAction" parameterType="map"
		resultType="org.cosmo.domain.IchijiHozonDTO">

		SELECT *
		FROM (
		SELECT
		HOZON_UID AS hozonUid,
		USER_UID AS userUid,
		SHINSEI_KBN AS shinseiKbn,
		SHOZOKU_CD AS shozokuCd,
		ALERT_NO AS alertNo,
		ALERT_SEQ AS alertSeq,
		ACTION_NM AS actionNm,
		DATA AS data,
		ADD_USER_ID AS addUserId,
		ADD_DATE AS addDate,
		UPD_USER_ID AS updUserId,
		UPD_DATE AS updDate
		FROM ICHIJI_HOZON
		WHERE USER_UID = #{userUid}
		AND ACTION_NM = #{actionNm}
		ORDER BY ADD_DATE DESC, UPD_DATE DESC
		)
		WHERE ROWNUM = 1
	</select>

</mapper>
